# REST API Analysis – Spring Modulith & Next.js Integration

## Executive Summary

The Spring Modulith backend exposes a cohesive REST surface under `/api/**` that cleanly mirrors the modular boundaries defined in code. Products (catalog), cart/order workflows (orders), and supporting infrastructure (sessions, caching, observability) are consistently encapsulated. The Next.js 14 frontend consumes these endpoints using session-based authentication via the `BOOKSTORE_SESSION` cookie, while the backend internally delegates to a gRPC client when the extracted `orders-service` is enabled.

---

## 1. Endpoint Inventory

### Base URLs

| Environment | Base URL | Notes |
| --- | --- | --- |
| Local monolith | `http://localhost:8080` | Direct Spring Boot access (when `./mvnw spring-boot:run`) |
| Docker Compose ingress | `http://localhost` | nginx proxies `/` to Next.js (port 3000) and `/api/**` to the monolith |
| OpenAPI spec | `http://localhost:8080/api-docs` | JSON schema generated by SpringDoc |
| Swagger UI | `http://localhost:8080/swagger-ui.html` | Interactive explorer |

### 1.1 Products API (`/api/products`)

- Backed by `ProductRestController` (catalog module).
- Supports pagination (`page` query param, default 1) and individual product lookups.
- Returns `PagedResult<ProductDto>` where DTOs contain `code`, `name`, `description`, `imageUrl`, `price`.
- Intended to be cached client-side via React Query; backend also leverages Hazelcast for repeat lookups.

### 1.2 Cart API (`/api/cart`)

- Implemented in `CartRestController` (orders module).
- Stateless clients rely on the Hazelcast-backed HTTP session. Cookie name: `BOOKSTORE_SESSION`, SameSite=Strict, HttpOnly, 30-minute timeout.
- Endpoints:
  - `GET /api/cart` – returns the current `CartDto` (creates an empty cart if none exists).
  - `POST /api/cart/items` – adds/replaces the current cart item (`AddToCartRequest` with `code`, `quantity ≥ 1`).
  - `PUT /api/cart/items/{code}` – updates quantity (`UpdateQuantityRequest`).
  - `DELETE /api/cart` – clears the cart (`204 No Content`).

### 1.3 Orders API (`/api/orders`)

- Surface provided by `OrdersRestController`, delegating to the gRPC-backed `OrdersRemoteClient`.
- Endpoints:
  - `POST /api/orders` – accepts `CreateOrderRequest`, returns `201 Created` with `CreateOrderResponse` and `Location` header. Requires the cart session to be populated.
  - `GET /api/orders` – returns `List<OrderView>` (summary).
  - `GET /api/orders/{orderNumber}` – returns full `OrderDto` or `404`.
- Validation errors surface via `OrdersRestExceptionHandler` with rich error payloads.

---

## 2. Session & Security Model

- **Cookie:** `BOOKSTORE_SESSION`
  - Configured in `application.properties` (`server.servlet.session.cookie.*`).
  - HttpOnly + SameSite=Strict; `USE_SECURE_COOKIES` toggle exists for HTTPS deployments.
- **Storage:** Spring Session with Hazelcast (`spring.session.store-type=hazelcast`).
- **Frontend usage:** Next.js React Query hooks specify `credentials: 'include'`; nginx keeps frontend/backend on the same origin in Compose, eliminating CORS in production.
- **Development CORS:** `CorsConfig` activates under the `dev` profile to allow `http://localhost:3000`.

Authentication is currently open; future milestones plan to add JWT/OAuth flows once the frontend authentication story is defined.

---

## 3. Internal Architecture Alignment

| Concern | Implementation | Notes |
| --- | --- | --- |
| Catalog reads | `catalog` module, `ProductService` + `ProductApi` | Exposed via REST and reused by orders via API facade |
| Cart state | `CartUtil` (orders module) + Hazelcast session storage | MapStore-free; purely session-based |
| Orders persistence | `OrderService` + `OrderRepository` (orders module) | Write-through cache via `OrderMapStore` for Hazelcast |
| Cross-module access | Strictly via exported APIs/events | Verified by `ModularityTests` |
| External integration | gRPC bridge (`OrdersGrpcClient`/`OrdersGrpcService`) | REST controller stays unchanged when remote service is enabled |

The REST API mirrors these boundaries; no module leaks detected (e.g., config module no longer references orders internals after `HazelcastOrderCacheConfig` was introduced).

---

## 4. Tooling, Docs & SDKs

- **OpenAPI / Swagger:** Managed via SpringDoc configuration (`springdoc.group-configs` etc).
- **TypeScript SDK:** Generated with `openapi-typescript` (`pnpm gen:types`) into `frontend-sdk/`.
- **Testing:** `k6.js` load script now targets `/api/cart/items` and `/api/orders` with the `BOOKSTORE_SESSION` cookie, mirroring browser behaviour.
- **Observability:** HTTP spans are captured by OpenTelemetry and exported to HyperDX. Modulith’s `/actuator/modulith` endpoint documents module interactions.

---

## 5. Integration Checklist

1. Always include credentials when making browser-based requests (`fetch(..., { credentials: 'include' })`).
2. Handle `201 Created` + `Location` for order creation; fall back to response body’s `orderNumber`.
3. Expect `404` for missing resources and structured `ErrorResponse` bodies for validation failures.
4. Leverage the generated TypeScript SDK or consult Swagger UI for authoritative models.
5. When running outside Docker Compose, enable the `dev` profile or set `cors.allowed-origins` so `http://localhost:3000` can access the API.

---

## 6. Future Considerations

- **Authentication:** add OAuth/JWT guards once user management is introduced.
- **Cart multi-item support:** backend currently stores a single item; any UX change must update DTOs and cart utilities.
- **gRPC evolution:** orders REST endpoints already proxy to gRPC—external consumers can transition gradually.
- **Rate limiting & audit logging:** currently absent; may be added as observability requirements grow.

The current API surface accurately reflects the Spring Modulith codebase and is ready for both the Next.js storefront and external integrations.
